## 第二章 TCP/IP基础

### 1. TCP/IP具体含义

- TCP/IP不仅仅是指TCP与IP两种协议；
- 具体来说，IP或ICMP、TCP 或UDP、TELNET或FTP、以及 HTTP等都属于TCP/IP的协议，TCP/IP 泛指上述协议。它们与TCP或IP的关系紧密，是互联网必不可少的组成部分。

![TCPIP协议群](images\TCPIP协议群.png)



### 2. 互联网与TCP/IP

- 互联网进行通信时，需要相应的网络协议，TCP/IP原本就是为使用互联网而开发定制的协议族。
- 因此，互联网的协议是TCP/IP。



### 3. TCP/IP参考模型

#### 3.1 物理层

- 实现相邻计算机节点之间比特流的透明传输；
- 透明传输：只传输数据而不对数据做任何的改变，且屏蔽了具体的传输介质和物理设备的差异。



#### 3.2 链路层

- 将网络层传下来的ip数据报组装成帧；
- 数据链路层负责通过一条链路从一个节点向物理链路直接相连的另一个结点传送数据报。



#### 3.3 网络层

 	**a. IP 协议**

- 网络层使用IP协议，IP协议基于IP地址转发分包数据；

- IP分组交换的一种协议，但不具有重发机制，即使分组数据包未能到达对端主机也不会重发。因此属于非可靠性传输协议。

  **b. ICMP协议**

- 用来诊断网络的健康状况；

- IP数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个发生异常的通知。

  **c. ARP协议**

- 从分组数据包的IP地址中解析出MAC地址的一种协议。



#### 3.4 传输层

- 为两台终端设备`应用程序`之间的的通信提供服务，计算机内部通常同一时间运行着多个程序，因此需要通过端口号识别这些应用程序；
- 典型的是TCP和UDP。



#### 3.5 应用层

- 应用层位于传输层之上，为两个终端设备上`应用程序`之间的信息交换提供服务；
- 定义了数据交换的格式；
- 我们所使用的软件是应用程序，只是一个**壳子**，而这些**软件里嵌套的协议**才是应用层的内容，使用网络的程序需要集成协议才可以正常使用；



### 4. OSI参考模型

>参考：[csdn](https://blog.csdn.net/qq_46078451/article/details/119074961)
>
>主要内容：应用层、表示层、会话层

#### 4.1 应用层(Application Layer)

- 应用层定义的是应用程序用于请求网络服务的 **接口**，需要什么样的服务就需要在应用程序集成该协议；

- 因为用户的实际需求多种多样，就要求应用层采用不同的协议来解决不同应用类型的需求；
- 典型的协议有：文件传输协议FTP、电子邮件协议SMTP、万维网HTTP等。

![img](https://img-blog.csdnimg.cn/img_convert/1917055ddb13a753ca162a1c70b32020.png)



#### 4.2 表示层(Presentation Layer)

- 主要处理两个通信系统中交换信息的表示方式，比如数据格式的变换、数据加密解密、数据压缩和恢复等；
- 为了使不同的数据和信息之间能够互相交换，表示层采用抽象的标准方法定义数据结构。

![img](https://img-blog.csdnimg.cn/img_convert/ea14182aa162562741a6d24ed6ddecda.png)



#### 4.3 会话层(Session Layer)

- 在传输层建立的连接线路上，建立会话进行数据传输。

![img](https://img-blog.csdnimg.cn/img_convert/9d7ac7ed8d642de2c3c008482be26960.png)



### 5.  TCP/IP 和 OSI参考模型

>参考：[会话层的会话和传输层中的连接的区别](https://www.cnblogs.com/FengZeng666/p/15336561.html)

#### 5.1 传输层的连接 & 会话层的会话

(1) 定义

- connection连接：是一个物理的概念，它指的是一个通过网络建立的客户端和服务器的一个网络连接，是一条物理路径；
- 会话session：是一个逻辑的概念，一个连接可以拥有多个会话也可以没有会话，同一个连接上的不同会话之间不会相互影响。

(2) 比喻

- 有A/B两个城市，需要从A运送白菜到B城，我们先建设一条公路 ( 类比于连接 )；
- 然后由A向B运送白菜 ( 类比于一次会话 )，包括准备白菜和运送白菜以及返回等一系列的动作；
- 一条公路，可以运送0-n次的白菜，当然从A到B的公路也可能不只一条。



#### 5.2 OSI 和 TCP/IP 关系图

- 二者关系图如下。

![OSI 和 TCPIP](images\OSI 和 TCPIP.png)





### 6. TCP/IP分层模型与通信示例

#### 6.1 发送数据包

**背景**：假设甲给乙发送电子邮件，内容为“早上好”。

(1) 应用程序处理

- 启动应用程序新建邮件，填写收件人邮箱，键盘输入邮件内容“早上好”，鼠标点击“发送”按钮后开始进行TCP/IP的通信；
- 首先应用程序中会进行编码处理。例如，中文电子邮件使用UTF-8进行编码，相当于OSI的表示层功能；
- 编码转化后，实际邮件不一定会马上被发送出去，因为有些邮件的软件有一次同时发送多个邮件的功能，也可能会有用户点击“收信”按钮以后才一并接收新邮件的功能，像这种何时建立通信连接何时发送数据的管理功能，从某种宽泛的意义上看属于OSI参考模型中会话层的功能；
- 应用在发送邮件的那一刻建立TCP连接，从而利用这个TCP连接发送数据。它的过程首先是将应用的数据发送给下一层的TCP，再做实际的转发处理。



(2) TCP模块处理

- TCP提供将应用层发来的数据顺利发送至对端的可靠传输，为了实现TCP的这一功能需要在应用层数据的前端附加一个TCP首部；
- TCP首部中包括源端口号和目的端口号、序号以及校验和，随后将附加了 TCP首部的包再发送给IP。 



(3) IP模块的处理 

- IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据，并在TCP首部的前端在加上自己的IP首部，生成ip包；
- IP包生成后，参考路由控制表决定接受此IP包的路由或主机。随后，IP包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正发送数据；
- 如果尚不知道接收端的MAC地址，可以利用ARP（Address Resolution Protocol）查找。只要知道了对端 的MAC地址，就可以将MAC地址和IP地址交给以太网的驱动程序，实现数据传输。 



 (4) 网络接口（以太网驱动）的处理 

- 在接收到的IP包附加上以太网首部并进行发送处理；
- 以太网首部中包含接收端MAC地址、发送端MAC地址以及标志以太网类型的以太网数据的协议。



(5) 以发送邮件为例说明数据的传输：

![发送数据包流程](images\发送数据包流程.png)



#### 6.2 接收数据包

**背景**：假设甲给乙发送电子邮件，内容为“早上好”。

(1) 网络接口（以太网驱动）的处理

- 主机收到以太网包以后，首先从以太网的包首部找到MAC地址判断是否为发给自己的包；
- 如果不是发给自己的包则丢弃数据，如果接收到的恰好是发给自己的包，就查找以太网包首部中的类型域从而确定以太网协议所传送过来的数据类型，如果以太网包首部的类型域包含了一个无法识别的协议类型，则丢弃数据。

(2) IP模块的处理 

- IP模块收到IP包首部及后面的数据部分以后，判断首部中的IP地址和自己的IP地址是否匹配；
- 如果判断得出包首部中的IP地址与自己的IP地址匹配，则可接收数据并从中查找上一层的协议。如果上一层是TCP就将IP包首部之后的部分传给 TCP处理；如果是UDP则将IP包首部后面的部分传给UDP处理；
- 对于有路由器的情况下，接收端地址往往不 是自己的地址，此时，需要借助路由控制表，在调查应该送达的主机或路由器以后再转发数据。

(3) TCP模块的处理

- 在TCP模块中，首先会计算一下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序；
- 数据接收完毕后，接收端则发送一个“确认回执”给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。 数据被完整地接收以后，会传给由端口号识别的应用程序。

(4) 应用程序的处理

- 接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的收件人地址是乙的地址。