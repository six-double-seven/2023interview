# Nginx

# 1.ip和域名的关系

1个域名只能对应1个ip，但1个ip可以对应多个域名；

域名在DNS服务器做解析时，一条记录只能指向一个ip地址，显然如果域名指向多个ip那应该去访问哪一个具体服务器呢

# 2.正向代理&反向代理

>正向代理

- 正向代理，意思是一个位于客户端和原始服务器（origin server）之间的代理服务器，为了从原始服务器取得内容，客户端向代理服务器发送一个请求并指定目标（原始服务器），然后代理向原始服务器转交请求并将获得的内容返回给客户端;
- 正向代理是为我们服务的，即为客户端服务的，客户端可以根据正向代理访问到它**本身无法访问到的服务器资源**
- 正向代理对我们是透明的，对服务端是非透明的，即服务端并不知道自己收到的是来自代理的访问还是来自真实客户端的访问。

![img](https://img-blog.csdnimg.cn/3fd6e22314194489b73b66e9e5348b3c.png)

>反向代理

- 反向代理（Reverse Proxy）方式是指通过代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。
- 反向代理是为服务端服务的，反向代理可以帮助服务器接收来自客户端的请求，帮助服务器做请求转发，负载均衡等。
- 反向代理对服务端是透明的，对我们是非透明的，即我们并不知道自己访问的是代理服务器，而服务器知道反向代理在为他服务。

![img](https://img-blog.csdnimg.cn/0798e9e22b7f4aa8afc3383e85feedf7.png)

> 反向代理的优势：

- 隐藏真实服务器；
- 负载均衡便于横向扩充后端动态服务；
- 动静分离，提升系统健壮性；

# 3.Nginx介绍

Nginx 是开源、高性能的 Web 和反向代理服务器，支持几乎可以做到 7 * 24 小时不间断运行，即使运行几个月也不需要重新启动，还能在不间断服务的情况下对软件版本进行热更新。性能是 Nginx 最重要的考量，其占用内存少、并发能力强、能支持高达 5w 个并发连接数。

![img](https://img-blog.csdnimg.cn/b822b2ce89bc4eb7bb27a0564e903509.png)



# 4.Nginx-负载均衡

- 一般情况下，客户端发送多个请求到服务器，服务器处理请求，其中一部分可能要操作一些资源比如数据库、静态资源等，服务器处理完毕后，再将结果返回给客户端。
- 在请求爆发式增长的情况下，单个机器性能再强劲也无法满足要求了，这个时候集群的概念产生了，单个服务器解决不了的问题，可以使用多个服务器，然后将请求分发到各个服务器上，将负载分发到不同的服务器，这就是负载均衡，核心是「**分摊压力**」。**Nginx 实现负载均衡，一般来说指的是将请求转发给服务器集群**

![img](https://img-blog.csdnimg.cn/6025d6e6a67049c6bfd5ff1dd10ad34d.png)

# 5.负载均衡策略

- 轮询策略：默认情况下采用的策略，将所有客户端请求轮询分配给服务端。这种策略是可以正常工作的，但是如果其中某一台服务器压力太大，出现延迟，会影响所有分配在这台服务器下的用户。

  ```js
  upstream myserver{
      server 127.0.0.1:8080;
      server 127.0.0.1:8081;
  }
  ```

- weight（权重）：默认为1，权重越高，分配的请求越多

  ```js
  upstream myserver{
      server 127.0.0.1:8080 weight=1;
      server 127.0.0.1:8081 weight=2;
  }
  ```

- 最小连接数策略：将请求优先分配给压力较小的服务器，它可以平衡每个队列的长度，并避免向压力大的服务器添加更多的请求。

  ```js
  upstream myserver{
      least_conn;
      server 127.0.0.1:8080;
      server 127.0.0.1:8081;
  }
  ```

- 最快响应时间策略：优先分配给响应时间最短的服务器。

  ```js
  upstream myserver{
      fair;
      server 127.0.0.1:8080;
      server 127.0.0.1:8081;
  }
  ```

- 客户端 IP 绑定策略：来自同一个 IP 的请求永远只分配一台服务器，有效解决了动态网页存在的 session 共享问题。

  ```js
  upstream myserver{
      ip_hash;
      server 127.0.0.1:8080;
      server 127.0.0.1:8081;
  }
  ```

# 6.动静分离

>动静分离是指在 web 服务器架构中，为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析,加快解析速度。降低原来单个服务器的压力。

- 将动态资源和静态资源分离，由于 Nginx 的高并发和静态资源缓存等特性，经常将静态资源部署在 Nginx 上。
- 如果请求的是静态资源，直接到静态资源目录获取资源
- 如果是动态资源的请求，则利用反向代理的原理，把请求转发给对应后台应用去处理，从而实现动静分离。
- 使用前后端分离后，可以很大程度提升静态资源的访问速度，即使动态服务不可用，静态资源的访问也不会受到影响。

![img](https://img-blog.csdnimg.cn/46829466b5f34063aa979f19691f2fa7.png)

# 7.Keepalived

- 使用Nginx+[Keepalived](http://www.keepalived.org/)的方式来可以高可用性（High Availability）和负载均衡。
- 高可用性是什么？即当前服务器出现故障时，可以将该服务器中的服务、资源、IP等转移到另外一台服务器上，从而满足业务的持续性；这两台或多台服务器构成了服务器**高可用集群**。Keepalived 能够在主服务器（Master）出现故障时无缝切换到备份服务器（Backup）
- **Nginx+Keepalived**架构使用DNS轮询的方式将域名绑定到211.151.229.80和211.151.229.99两个虚拟IP上，每个虚拟IP对应**一主一备**两台服务器，根据Nginx所在服务器上的keepalived配置（/etc/keepalived/keepalived.conf）的优先级（priority）区分主、备服务器（优先级高的为主），将请求发送给主服务器上。同时keepalived服务能够通过脚本时刻监测本机Nginx是否正常提供服务，若Nginx服务停止或出现宕机等情况，这个虚拟IP会自动无缝切换到备份服务器，实现高可用性。
